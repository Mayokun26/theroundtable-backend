// filepath: c:\Users\Oreko\work\TheRoundTable\theroundtable-backend\src\test-connections.ts
import dotenv from 'dotenv';
import Redis from 'ioredis';
import { OpenAI } from 'openai';
import { ListTablesCommand, DynamoDBClient } from '@aws-sdk/client-dynamodb';
import { logger } from './utils/logger';

dotenv.config();

async function testConnections() {
  console.log('\n🔍 Testing Environment Variables:\n');
  
  // Check required environment variables
  const requiredVars = [
    'AWS_REGION', 
    'DYNAMODB_TABLE_PREFIX',
    'REDIS_HOST',
    'REDIS_PORT',
    'OPENAI_API_KEY'
  ];

  for (const varName of requiredVars) {
    if (!process.env[varName]) {
      console.error(`❌ Missing ${varName}`);
    } else {
      console.log(`✅ ${varName} is set`);
    }
  }

  console.log('\n🔍 Testing DynamoDB Connection:\n');
  try {
    const client = new DynamoDBClient({
      region: process.env.AWS_REGION || 'us-east-1',
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || '',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || ''
      },
      ...(process.env.DYNAMODB_ENDPOINT ? { endpoint: process.env.DYNAMODB_ENDPOINT } : {})
    });

    const command = new ListTablesCommand({});
    const result = await client.send(command);
    console.log('✅ DynamoDB connected successfully');
    console.log('📋 Tables in DynamoDB:', result.TableNames);
  } catch (err) {
    console.error('❌ DynamoDB connection failed:', err);
  }

  console.log('\n🔍 Testing Redis Connection:\n');
  try {
    const redisOptions = {
      host: process.env.REDIS_HOST || 'localhost',
      port: parseInt(process.env.REDIS_PORT || '6379'),
      ...(process.env.REDIS_PASSWORD ? { password: process.env.REDIS_PASSWORD } : {})
    };

    const redis = new Redis(redisOptions);
    
    await redis.ping();
    console.log('✅ Redis connected successfully');
    
    // Test set and get
    await redis.set('test-key', 'test-value');
    const value = await redis.get('test-key');
    console.log('📋 Redis test value:', value);
    
    await redis.quit();
  } catch (err) {
    console.error('❌ Redis connection failed:', err);
  }

  console.log('\n🔍 Testing OpenAI API Connection:\n');
  try {
    if (!process.env.OPENAI_API_KEY) {
      console.error('❌ OpenAI API key is missing');
    } else {
      const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
      
      // Just check if we can initialize the client
      console.log('✅ OpenAI API client initialized');
      // We won't make an actual API call to avoid consuming tokens
      console.log('ℹ️ Skipping actual OpenAI API call to avoid token usage');
    }
  } catch (err) {
    console.error('❌ OpenAI API client initialization failed:', err);
  }

  console.log('\n✨ Connection tests completed\n');
}

// Run the tests
testConnections()
  .then(() => process.exit(0))
  .catch((err) => {
    console.error('Tests failed with error:', err);
    process.exit(1);
  });
